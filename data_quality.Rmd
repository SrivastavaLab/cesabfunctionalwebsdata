---
title: "Data Quality checks for the BWG"
author: "Andrew"
date: "14. 11. 2016"
output: 
  html_document:
    toc: true
    toc_depth: 5
    toc_float: true
    code_folding: hide
    theme: paper
---

```{r}
loc <- dataset %>% str_replace("_", " ")

site_data <- dats_date %>% 
  filter(country == loc)
```
#Response variables for `r dataset %>% str_replace("_", " ")`

## Location data

Where in the world is this site? Note that any warnings around the figure below indicate that there is a ***problem with the coordinates***.
```{r}

ggmap(stamenmap) + 
  geom_point(colour = "red", size = 3, alpha = 0.5, 
             data = site_data %>% 
               select(lon = lng, lat))
```


the sites and the years they were  collected: 

```{r}
site_data %>% 
  select(name, year) %>% 
  distinct() %>% 
  arrange(year) %>% 
  kable
```

Info on the person responsible:

```{r}
site_data %>% select(owner_name:faculty_email) %>% distinct %>% kable
```


## Detritus & other Bromeliad things

```{r fig.height=7, fig.width=12, fig.cap="", message=FALSE, dev= 'svg'}
canonical_brom_data <- detritus_wider_FG_detritus_corrected %>% 
  ## take out se -- these are errors from prediction
  select(-dplyr::contains("_se")) %>% 
  # just this site
  semi_join(site_data) %>% 
  # add bromeliad spp names
  left_join(broms_date %>% select(bromeliad_id, species)) 


canonical_brom_data_long <- canonical_brom_data %>% 
  gather(var, val, -visit_id, -bromeliad_id, -dataset_id, -dataset_name, -species)


make_distrib_plot <- function(varname, .canonical_brom_data_long = canonical_brom_data_long) {
  .canonical_brom_data_long %>% 
    filter(var %in% c(varname)) %>% 
    complete(species, dataset_name) %>% 
    ggplot(aes(fill = species, x = val)) +
    geom_density() +
    geom_rug() + 
    facet_grid(species~dataset_name) +
    scale_fill_viridis(discrete = TRUE) +
    theme_minimal() +
    ggtitle(varname) +
    xlab("Value")
}

present_data <- canonical_brom_data_long %>% 
  nest(val) %>% 
  mutate(absent = map_lgl(data, ~ all(is.na(.x)))) %>% 
  filter(!absent) %>% 
  unnest(data)

present_var_names <- present_data %>% 
  select(-absent) %>% 
  .[["var"]] %>% 
  unique

plots <- map(present_var_names, make_distrib_plot, .canonical_brom_data_long = canonical_brom_data_long)

walk(plots, print)

```

Other ideas:

minimum
maximum
median
sd (arrange data by descending sd)

