---
title: "Data Quality checks for the BWG"
author: "Andrew"
date: "14. 11. 2016"
output: 
  html_document:
    toc: true
    toc_depth: 5
    toc_float: true
    code_folding: hide
    theme: paper
---

## Dataset itself

For Puerto Rico only:

```{r}
site_data <- dats_date %>% 
  filter(country == "Puerto Rico")
```
## location data

Where in the world is this site? Note that any warnings around the figure below indicate that there is a *problem with the coordinates*
```{r}

ggmap(stamenmap) + 
  geom_point(colour = "darkgreen", data = site_data %>% 
               select(lon = lng, lat))
```


the sites and the years they were  collected: 

```{r}
site_data %>% 
  select(name, year) %>% 
  distinct() %>% 
  arrange(year)
```

Info on the person responsible:

```{r}
site_data %>% select(owner_name:faculty_email) %>% distinct %>% kable
```

(maybe place personal information separately? or release dates separately?)


a map?

## Detritus & other Bromeliad things

```{r fig.height=9, fig.width=10}
canonical_brom_data <- detritus_wider_FG_detritus_corrected %>% 
  ## take out se -- these are errors from prediction
  select(-dplyr::contains("_se")) %>% 
  # just this site
  semi_join(site_data) %>% 
  # add bromeliad spp names
  left_join(broms_date %>% select(bromeliad_id, species)) 


canonical_brom_data_long <- canonical_brom_data %>% 
  gather(var, val, -visit_id, -bromeliad_id, -dataset_id, -dataset_name, -species)

make_distrib_plot <- function(varname, .canonical_brom_data_long = canonical_brom_data_long) {
  .canonical_brom_data_long %>% 
    filter(var %in% c(varname)) %>% 
    ggplot(aes(fill = species, x = val)) +
    geom_density() +
    geom_rug() + 
    facet_grid(species~dataset_name) +
    scale_fill_viridis(discrete = TRUE) +
    theme_dark() +
    ggtitle(paste0("Distribution of the variable ", varname))
}

present_data <- canonical_brom_data_long %>% 
  nest(val) %>% 
  mutate(absent = map_lgl(data, ~ all(is.na(.x)))) %>% 
  filter(!absent) %>% 
  unnest(data)

present_var_names <- present_data %>% 
  select(-absent) %>% 
  .[["var"]] %>% 
  unique

map(present_var_names, make_distrib_plot, .canonical_brom_data_long = present_data)

```

Number of plants of each species in each site:


